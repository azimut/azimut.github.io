#+TITLE: Retrocomputing: EEPROM programming
#+DATE: <2025-04-14 lun>
#+KEYWORDS: eeprom, arduino, sst29ee010, w29c020, eeprom programmer, arduino mega

[[./images/sst29.jpg]]

* Background

I've been wanting experiment with digital electronics, in the same vein of Ben Eater's [[https://www.youtube.com/playlist?list=PLowKtXNTBypGqImE405J2565dvjafglHU]["8-bit breadboard computers"]] video serie. And for that, I am going to need some sort of EEPROM where to store machine code.

* Hardware
** Arduino MEGA

An Arduino UNO was first entertained as a possible solution for this. But later timing and pin count requirements (more than 16 pins) made it a bit convoluted. Since I would need to do [[https://docs.arduino.cc/retired/hacking/software/PortManipulation/][Arduino Port]] programming with bitshifters. And hoping that after all that it will still comply with write timings.

So I ended up choosing an Arduino Mega, a board with more than enough GPIO pins for this task.

#+ATTR_HTML: :width 400
[[./images/arduino-mega.jpg]]

** The EEPROM

I found a ~SST29EE010~ on an old motherboard.

My initial happiness vanished as soon as I discovered that [[https://www.youtube.com/watch?v=K88pgWhEb1M][Ben Eater's]] EEPROM programmer script won't work right out of the box.

Turns out that it has some sort of software write protection (SDP). Which complicates writting to it.

A ~W29C020~ can also be used in the same way.

#+CAPTION: eeprom pinout
#+ATTR_HTML: :width 300
#+ATTR_ORG: :width 250
[[./images/sst29-pinout.jpg]]

* Theory

I found this [[https://www.youtube.com/watch?v=2jhTEAkjlpY][video]] useful in explaining what this EEPROM memory protection is. And how to practically disable it with custom software and an Arduino.

** EEPROM Read Protocol

- Controlled by CE# and OE# (# means active low)
  - both have to be low/active

- Seems pretty normal, at least compared to *28C256* which Ben Eater used.

|------+---------------+-----+-----|
|      |      <c>      | <c> | <c> |
| T_RC |  read cycle   | 90  |  âˆž  |
| T_AA |  addr access  |  -  | 90  |
| T_CE |  chip enable  |  -  | 90  |
| T_OE | output enable |  -  | 40  |
|------+---------------+-----+-----|

#+CAPTION: reading timings
#+ATTR_HTML: :width 600
#+ATTR_ORG: :width 800
[[./images/sst29-read.png]]

** EEPROM Write Protocol

- Writes have to follow a handshake part of SDP protocol.
- JEDEC standard Sofware Data Protection (SDP) protocol.
  1) 3-byte load sequence for SDP
    #+begin_src c
      eeprom[0x5555] = 0xAA;
      eeprom[0x2AAA] = 0x55;
      eeprom[0x5555] = 0xA0;
    #+end_src
  2) 1-byte load cycle to a page buffer
  3) internally controlled write cycle
- A0-A6 are used for page writes
- A15-A16 do not matter at all on ~SDP~ commands
- Any byte not loaded with user data will be written to FF

#+CAPTION: write timings
#+ATTR_HTML: :width 600
#+ATTR_ORG: :width 800
[[./images/sst29-write.png]]

- address is latched at falling edge of #WE
- data is latched at raising edge of #WE

- Said protocol can be disabled. Enabled on EEPROMs found.

* Detour: borring an Arduino.

While I started working on this I did so with an Arduino UNO using bitshifters. After failing miserable. And worst of all not knowing if it was my code or the physical limitations of my setup the cause of failure.

I opted for sacrifice a 3d printer to get an Arduino Mega from it to try without the register shifters.

In the process I learned how to dump the binary flash content of an arduino to a file with *avrdude*.

#+CAPTION: writes its output to flashdump.bin
#+begin_src sh
  $ avrdude -D -p atmega2560 -c wiring -P /dev/ttyACM0 -U flash:r:flashdump.bin:r -v
#+end_src

* Real world challenges

- Electronic Interference: turns out that if I cradle in my hand the Breadboard, including the Arduino, in my hand it will create some sort of noise that will affect readings.
- Bad Wiring: We are going to be using +24 GPIO pins from the Arduino to the EEPROM. Plus some that should be hardcoded to LOW, like CE. Double check wiring positioning and cable health.
- Ground all INPUTS not being used: As mentioned before, this is particularilly important for address inputs not used.
- Write code only for testing:
  - code to read serially (without using port programming) ensure the sanity of my port programmed code

* It works!

So, after some weird lectures and even weirder succesful-ish writes. I fixed some wirings and...it works!

#+begin_src
000:  41 42 43 44 45 46 47 48   01 02 04 08 10 20 40 80
010:  7f bf df ef f7 fb fd fe   00 ff 55 aa 30 31 32 33
020:  ea ea ea ea ea ea ea ea   ea ea ea ea ea ea ea ea
030:  ea ea ea ea ea ea ea ea   ea ea ea ea ea ea ea ea
040:  ea ea ea ea ea ea ea ea   ea ea ea ea ea ea ea ea
#+end_src

Which is exactly the test pattern given by TommyPROM. Meant to be a non random pattern easily discerned from noise.

#+begin_src c
  byte data[] = {
      'A',  'B',  'C',  'D',  'E',  'F',  'G',  'H',  0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80,
      0x7f, 0xbf, 0xdf, 0xef, 0xf7, 0xfb, 0xfd, 0xfe, 0x00, 0xff, 0x55, 0xaa, '0',  '1',  '2',  '3'
  };
#+end_src

* Source

This is the final code (for now) that I use to write the EEPROM using an arduino Mega heavily based on TommyPROM version of Ben Eater's code. You might find a more recent recent version [[https://github.com/azimut/arduino-sketches/tree/master/eeprom-mega][here]].

#+INCLUDE: "./sst29-mega.ino" src arduino
* Resources

- Arduino UNO https://github.com/TomNisbet/TommyPROM
  - uses bitshifters
  - alternative [[https://github.com/TomNisbet/TommyPROM/tree/master/unlock-ben-eater-hardware][code]] for Ben Eater setup

- Teensy 3.5 https://github.com/slu4coder/SST39SF010-FLASH-Programmer
  - teensy is waaaay faster than UNO/MEGA
  - uses has a clock of 120MHz, while my Arduino's have 16MHz.
  - has enough GPIO ports to NOT use bitshifters
  - does NOT use port programming

* New Feature: Multi page writting.

Today trying to write data to a ROM. Ended up hitting a bug that I missed. That is that it didn't support writting to multiple pages. Since each page is of 128 bytes. I added a pause (TBCLO) after each page write.

Seems to work :)

